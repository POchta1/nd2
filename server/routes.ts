import type { Express } from "express";
import { createServer, type Server } from "http";
import { z } from "zod";
import OpenAI from "openai";

const contactFormSchema = z.object({
  name: z.string().min(2, "–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞"),
  phone: z.string().min(10, "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"),
  email: z.string().email("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email").optional().or(z.literal("")),
  program: z.string().optional(),
  message: z.string().optional(),
  privacy: z.boolean().refine(val => val === true, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö")
});

const chatMessageSchema = z.object({
  message: z.string(),
  userProfile: z.object({
    program: z.string().optional(),
    level: z.string().optional(),
    age: z.string().optional(),
    goals: z.string().optional(),
    experience: z.string().optional()
  }),
  step: z.string()
});

// Initialize OpenAI client
const openai = process.env.OPENAI_API_KEY ? new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
}) : null;

export async function registerRoutes(app: Express): Promise<Server> {
  
  // Contact form submission
  app.post("/api/contact", async (req, res) => {
    try {
      const validatedData = contactFormSchema.parse(req.body);
      
      // In a real application, you would:
      // 1. Save to database
      // 2. Send email notification
      // 3. Integrate with CRM system
      // 4. Send SMS confirmation
      
      console.log("Contact form submission:", validatedData);
      
      // Simulate processing time
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      res.json({ 
        success: true, 
        message: "–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è." 
      });
      
    } catch (error) {
      if (error instanceof z.ZodError) {
        res.status(400).json({ 
          success: false, 
          message: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö",
          errors: error.errors 
        });
      } else {
        res.status(500).json({ 
          success: false, 
          message: "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" 
        });
      }
    }
  });

  // AI Chat endpoint
  app.post("/api/chat", async (req, res) => {
    try {
      const { message, userProfile, step } = chatMessageSchema.parse(req.body);
      
      console.log("Chat message:", { message, userProfile, step });

      if (!openai) {
        // Fallback response when OpenAI is not configured
        res.json({
          message: "–î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ AI –ø–æ–º–æ—â–Ω–∏–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º API –∫–ª—é—á OpenAI. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Ñ–æ—Ä–º–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.",
          step: step
        });
        return;
      }

      // Create context based on user profile
      const context = `
–í—ã - AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —à–∫–æ–ª—ã –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ "English Excellence". –í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –∫–ª–∏–µ–Ω—Ç–æ–º.

–≠–¢–ê–ü–´ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:
1. –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞
2. –£–∑–Ω–∞–π—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç/–≤–æ–∑—Ä–∞—Å—Ç–Ω—É—é –≥—Ä—É–ø–ø—É
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
4. –í—ã—è—Å–Ω–∏—Ç–µ —Ü–µ–ª–∏ –∏–∑—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞
5. –£–∑–Ω–∞–π—Ç–µ –æ–ø—ã—Ç –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
6. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Å –î–ï–¢–ê–õ–¨–ù–´–ú –æ–ø–∏—Å–∞–Ω–∏–µ–º

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–ì–†–ê–ú–ú–ê–•:

üéØ –û–ë–©–ò–ô –ê–ù–ì–õ–ò–ô–°–ö–ò–ô (4500‚ÇΩ/–º–µ—Å)
- –û–ø–∏—Å–∞–Ω–∏–µ: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —è–∑—ã–∫–∞
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ª–µ–∫—Å–∏–∫–∞, —á—Ç–µ–Ω–∏–µ, –ø–∏—Å—å–º–æ, –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–æ–≤–æ—Ä–µ–Ω–∏–µ
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: 95% —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ–≤—ã—à–∞—é—Ç —É—Ä–æ–≤–µ–Ω—å –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–≤–æ–±–æ–¥–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

üíº –ë–ò–ó–ù–ï–°-–ê–ù–ì–õ–ò–ô–°–ö–ò–ô (6500‚ÇΩ/–º–µ—Å)  
- –û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è –∫–∞—Ä—å–µ—Ä—ã
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: –¥–µ–ª–æ–≤–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –æ—Ç—Ä–∞—Å–ª–µ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: 80% –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ –∏–ª–∏ –Ω–æ–≤—É—é —Ä–∞–±–æ—Ç—É
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º –±–∏–∑–Ω–µ—Å–µ

üë∂ –ê–ù–ì–õ–ò–ô–°–ö–ò–ô –î–õ–Ø –î–ï–¢–ï–ô (3800‚ÇΩ/–º–µ—Å)
- –û–ø–∏—Å–∞–Ω–∏–µ: –ò–≥—Ä–æ–≤—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ –¥–ª—è –¥–µ—Ç–µ–π 5-17 –ª–µ—Ç
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: –æ—Å–Ω–æ–≤—ã —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ –∏–≥—Ä—ã, –ø–µ—Å–Ω–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: 90% –¥–µ—Ç–µ–π —Å–¥–∞—é—Ç —à–∫–æ–ª—å–Ω—ã–µ —ç–∫–∑–∞–º–µ–Ω—ã –Ω–∞ "–æ—Ç–ª–∏—á–Ω–æ"
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ª—é–±–æ–≤—å –∫ —è–∑—ã–∫—É –∏ –∫—Ä–µ–ø–∫–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

üéì –ü–û–î–ì–û–¢–û–í–ö–ê –ö IELTS (8500‚ÇΩ/–º–µ—Å)
- –û–ø–∏—Å–∞–Ω–∏–µ: –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º—É —ç–∫–∑–∞–º–µ–Ω—É
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–¥–∞—á–∏ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π IELTS
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –Ω–∞—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ 7.5
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—ã—Å–æ–∫–∏–µ –±–∞–ª–ª—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ –≤—É–∑—ã

üë®‚Äçüè´ –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ï –ó–ê–ù–Ø–¢–ò–Ø (1500‚ÇΩ/—É—Ä–æ–∫)
- –û–ø–∏—Å–∞–Ω–∏–µ: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –æ–ø—ã—Ç–Ω—ã–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ 3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ

üó£Ô∏è –†–ê–ó–ì–û–í–û–†–ù–´–ô –ö–õ–£–ë (2000‚ÇΩ/–º–µ—Å)
- –û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–∞–∫—Ç–∏–∫–∞ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è —Å –Ω–æ—Å–∏—Ç–µ–ª—è–º–∏ —è–∑—ã–∫–∞
- –ß–µ–º—É –Ω–∞—É—á–∏—Ç–µ—Å—å: –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞, –±–µ–≥–ª–æ—Å—Ç—å —Ä–µ—á–∏
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤: 100% —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞—á–∏–Ω–∞—é—Ç —Å–≤–æ–±–æ–¥–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã

–î–û–°–¢–ò–ñ–ï–ù–ò–Ø –®–ö–û–õ–´:
- 15 –ª–µ—Ç –æ–ø—ã—Ç–∞
- –ë–æ–ª–µ–µ 5000 –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤
- 98% –¥–æ–≤–æ–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –°–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è

–ü–†–ê–í–ò–õ–ê:
- –ó–∞–¥–∞–≤–∞–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –∑–∞ —Ä–∞–∑
- –°–æ–±–∏—Ä–∞–π—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ—ç—Ç–∞–ø–Ω–æ
- –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞–π—Ç–µ –î–ï–¢–ê–õ–¨–ù–£–Æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º
- –ú–æ—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫ –Ω–∞—á–∞–ª—É –æ–±—É—á–µ–Ω–∏—è

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "${message}"
–¢–µ–∫—É—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: –≤–æ–∑—Ä–∞—Å—Ç: ${userProfile.age || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, —É—Ä–æ–≤–µ–Ω—å: ${userProfile.level || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, —Ü–µ–ª–∏: ${userProfile.goals || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, –æ–ø—ã—Ç: ${userProfile.experience || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
`;

      // the newest OpenAI model is "gpt-4o" which was released May 13, 2024. do not change this unless explicitly requested by the user
      const completion = await openai.chat.completions.create({
        model: "gpt-4o",
        messages: [
          { role: "system", content: context },
          { role: "user", content: message }
        ],
        max_tokens: 500,
        temperature: 0.7
      });

      const aiResponse = completion.choices[0].message.content || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å.";

      res.json({
        message: aiResponse,
        step: step
      });

    } catch (error) {
      console.error("Chat API error:", error);
      
      if (error instanceof z.ZodError) {
        res.status(400).json({ 
          message: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö",
          step: "error"
        });
      } else {
        res.status(500).json({ 
          message: "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É.",
          step: "error"
        });
      }
    }
  });

  const httpServer = createServer(app);
  return httpServer;
}
